-- Execute dentro de uma transação se desejar (BEGIN; ... COMMIT;)
DO $$
DECLARE
  r   record;
  cols_insert  text := '';
  cols_select  text := '';
BEGIN
  -- Varre as colunas da tabela de staging na ordem correta
  FOR r IN
    SELECT column_name
    FROM information_schema.columns
    WHERE table_schema = 'stagging'
      AND table_name  = 'stg_pedidos'
    ORDER BY ordinal_position
  LOOP
    cols_insert := cols_insert || CASE WHEN cols_insert <> '' THEN ', ' ELSE '' END
                  || quote_ident(r.column_name);

    cols_select := cols_select || CASE WHEN cols_select <> '' THEN ', ' ELSE '' END ||
      CASE r.column_name
        -- Regras específicas
        WHEN 'tipo_operacao'             THEN '''0''::text AS '||quote_ident(r.column_name)
        WHEN 'arquivo_origem'            THEN '''arquivo_backup_banco''::text AS '||quote_ident(r.column_name)
        WHEN 'data_prev_entrega'         THEN 'p.data_prev_entrega::text AS '||quote_ident(r.column_name)
        WHEN 'data_prev_entrega_original'THEN 'p.data_prev_entrega::text AS '||quote_ident(r.column_name)
        WHEN 'cnpj_cpf_transportadora'   THEN 'p.cnpj_cpf_dest::text AS '||quote_ident(r.column_name)
        WHEN 'chegada_transportadora'    THEN 'p.chegada_na_transportadora::text AS '||quote_ident(r.column_name)
        WHEN 'grau_risco'                THEN 'p.grau_de_risco::text AS '||quote_ident(r.column_name)
        -- 1:1: se a coluna existir em public.pedidos, copia e CAST pra text
        ELSE CASE
          WHEN EXISTS (
            SELECT 1 FROM information_schema.columns c
            WHERE c.table_schema='public' AND c.table_name='pedidos'
              AND c.column_name = r.column_name
          )
          THEN 'p.'||quote_ident(r.column_name)||'::text AS '||quote_ident(r.column_name)
          -- Se só existe na staging e não há regra, preenche NULL::text
          ELSE 'NULL::text AS '||quote_ident(r.column_name)
        END
      END;
  END LOOP;

  EXECUTE
    'INSERT INTO stagging.stg_pedidos ('||cols_insert||') '||
    'SELECT '||cols_select||' FROM public.pedidos p;';
END $$;