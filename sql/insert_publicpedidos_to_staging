DO $$
DECLARE
  r   record;
  cols_insert  text := '';
  cols_select  text := '';
BEGIN
  FOR r IN
    SELECT s.column_name,
           p.data_type AS src_type
    FROM information_schema.columns s
    LEFT JOIN information_schema.columns p
      ON p.table_schema='public' AND p.table_name='pedidos' AND p.column_name=s.column_name
    WHERE s.table_schema='staging' AND s.table_name='stg_pedidos'
    ORDER BY s.ordinal_position
  LOOP
    cols_insert := cols_insert || CASE WHEN cols_insert <> '' THEN ', ' ELSE '' END
                  || quote_ident(r.column_name);

    cols_select := cols_select || CASE WHEN cols_select <> '' THEN ', ' ELSE '' END ||
      CASE r.column_name
        WHEN 'tipo_operacao'               THEN '''0''::text AS '||quote_ident(r.column_name)
        WHEN 'arquivo_origem'              THEN '''arquivo_backup_banco''::text AS '||quote_ident(r.column_name)
        WHEN 'data_prev_entrega'           THEN 'to_char(p.data_prev_entrega,''DD/MM/YYYY HH24:MI:SS'') AS '||quote_ident(r.column_name)
        WHEN 'data_prev_entrega_original'  THEN 'to_char(p.data_prev_entrega,''DD/MM/YYYY HH24:MI:SS'') AS '||quote_ident(r.column_name)
        WHEN 'cnpj_cpf_transportadora'     THEN 'p.cnpj_cpf_dest::text AS '||quote_ident(r.column_name)
        WHEN 'chegada_transportadora'      THEN 'to_char(p.chegada_na_transportadora,''DD/MM/YYYY HH24:MI:SS'') AS '||quote_ident(r.column_name)
        WHEN 'grau_risco'                  THEN 'p.grau_de_risco::text AS '||quote_ident(r.column_name)
        ELSE
          CASE
            WHEN r.src_type IS NULL THEN 'NULL::text AS '||quote_ident(r.column_name)
            WHEN r.src_type IN ('timestamp without time zone','timestamp with time zone')
              THEN 'to_char(p.'||quote_ident(r.column_name)||',''DD/MM/YYYY HH24:MI:SS'') AS '||quote_ident(r.column_name)
            WHEN r.src_type='date'
              THEN 'to_char(p.'||quote_ident(r.column_name)||',''DD/MM/YYYY'') AS '||quote_ident(r.column_name)
            WHEN r.src_type LIKE 'time%'
              THEN 'to_char(p.'||quote_ident(r.column_name)||',''HH24:MI:SS'') AS '||quote_ident(r.column_name)
            ELSE
              'p.'||quote_ident(r.column_name)||'::text AS '||quote_ident(r.column_name)
          END
      END;
  END LOOP;

  EXECUTE
    'INSERT INTO staging.stg_pedidos ('||cols_insert||') '||
    'SELECT '||cols_select||' FROM public.pedidos p;';
END $$;
